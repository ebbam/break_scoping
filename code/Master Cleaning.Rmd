---
title: "Cleaning_all"
author: "Ebba Mark"
date: "`r Sys.Date()`"
output: html_document
---

## Introduction

Main file for cleaning and judging completeness/scope of various downloaded 
data files. Each chunk caters to one data file and, at this point, 
only produces heat maps for each relevant variable in a dataset.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(here)
library(tidyverse)
library(readxl)
library(openxlsx)
library(stringr)
library(gets)
library(getspanel)
library(janitor)
library(superheat)
library(skimr)

```

```{r}
EU15 <- c("Austria", "Belgium", "Germany", "Denmark", "Spain", "Finland",
          "France", "United Kingdom", "Ireland", "Italy", "Luxembourg", 
          "Netherlands", "Greece", "Portugal", "Sweden")

EU31 <- c("Austria", "Croatia", "Belgium", "Bulgaria", "Cyprus", 
          "Czech Republic", "Germany", "Denmark", "Spain", "Estonia", "Finland",
          "France", "United Kingdom", "Greece", "Hungary", "Ireland", "Italy",
          "Lithuania", "Luxembourg", "Latvia", "Malta", "Netherlands", "Poland",
          "Portugal", "Romania", "Slovak Republic", "Slovenia", "Sweden", 
          "Switzerland", "Iceland", "Norway")

OECD <- readRDS(here("data/out/oecd_countries.rds"))


gen_hms <- function(vars, ds, lab){
  # Check that all EU31 and OECD countries are present/named correctly
  test <- c(EU31, OECD)[!(c(EU31,OECD) %in% ds$country)]
  if(length(test) == 0){
    print("All OECD/EU31 countries present/correctly labelled.")
  }else{print(test)}
  
  ds_eu_oecd <- ds %>% filter(country %in% c(EU31, OECD))
  ds_else <- ds %>% filter(!(country %in% c(EU31, OECD)))
  
  heatmaps <- c()
  
  for(v in vars){
    for(j in 1:2){
      if(j == 1){dat = ds_eu_oecd}else{dat = ds_else}
    hm <- dat %>% 
      filter(get(lab) == v) %>% 
      select(country, year, emissions) %>%
      pivot_wider(id_cols = country, names_from = year, values_from = emissions) %>%
      as.data.table %>%
      as.matrix(rownames = 1) %>%
      superheat(heat.na.col = "red",
                heat.pal = c(low = "skyblue", high = "darkblue"),
                bottom.label.text.angle = 90,
                force.left.label = TRUE,
                title = paste(v, ifelse(identical(dat, ds_eu_oecd), "EU_OECD", "ELSE")))
      heatmaps <- c(heatmaps, hm)
    }
  }
}

```


## EDGAR V6.0

```{r EDGARV6}
edgar <- read_excel(here("data", "raw", "v60_CO2_excl_short-cycle_org_C_1970_2018.xls"), skip = 9) %>%
  mutate(Name = ifelse(Name=="Slovakia", "Slovak Republic", ifelse(Name == "Korea, Republic of", "Korea", Name))) %>%
  pivot_longer(cols = starts_with("Y_"), names_to = "year", values_to = "emissions") %>% 
  clean_names() %>% 
  mutate(year=as.numeric(str_remove(year, "Y_")), emissions = as.numeric(emissions)) %>% 
  rename(country = name, ipcc_code = ipcc_code_2006_for_standard_report, ipcc_code_name = ipcc_code_2006_for_standard_report_name) %>% 
  select(-c_group_im24_sh)

vars <- unique(edgar$ipcc_code)
gen_hms(vars, edgar, 'ipcc_code')

pdf("EDGAR_plots.pdf")
edgar %>% select(country, year, ipcc_code, ipcc_code_name, emissions) %>% 
  filter(emissions > 0) %>% 
  group_by(ipcc_code_name) %>% 
  summarise(start = min(year), end = max(year)) %>% 
  ggplot() +
    aes(y = ipcc_code_name) +
    geom_segment(aes(x = start, 
                     xend = end,
                     yend = ipcc_code_name,
                     color = ipcc_code_name), 
                 size = 5,
                 show.legend = FALSE) +
  geom_text(aes(x = start, label = start), 
              nudge_x = 3,
              size = 3) +
 labs(title = "EDGAR v6.0 Emissions data by sector", subtitle = paste("Year coverage from 1970 to 2020"))
 
edgar %>% select(country, year, ipcc_code, ipcc_code_name, emissions) %>% 
  filter(emissions > 0) %>% 
  group_by(ipcc_code_name, year) %>% 
  summarise(obs = n(), n_OECD = sum(country %in% c(EU31, OECD))) %>% 
  ggplot(., aes(x = year)) + 
  geom_col(aes(y = obs, fill = "blue")) +
  geom_col(aes(y = n_OECD, fill = "green")) +
  geom_hline(yintercept = 43, linetype = "dashed") +
  facet_wrap(~ipcc_code_name) +
  theme(legend.position = "none") +
  labs(title = "EDGAR v6.0 Emissions data by sector", subtitle = "Country coverage from 1970 to 2020.")

edgar %>% select(country, year, ipcc_code, ipcc_code_name, emissions) %>% 
  #group_by(as.factor(country), ipcc_code_name) %>% 
  ggplot(aes(x = year, y = emissions)) +
  geom_line(aes(fill = country)) +
  facet_wrap(~ipcc_code_name, scales = "free") +
    labs(title = "EDGAR v6.0 Emissions data by sector", subtitle = "Emissions statistics by country from 1970 to 2020.")

dev.off()


```

## IRENA Electricity Generation

IRENA (2021), Renewable energy statistics 2021, International Renewable
Energy Agency (IRENA), Abu Dhabi

Electricity generation (GWh) is the gross electricity produced by electricity
plants, combined heat and power plants (CHP) and distributed generators measured
at the output terminals of generation. It includes on-grid and off-grid generation,
and it also includes the electricity self-consumed in energy industries; not
only the electricity fed into the grid (net electricity production).

```{r IRENA Elec gen, echo=FALSE}
ongrid <- read_xlsx(here("data", "raw", "ELECGEN_IRENA_ONGRID.xlsx"), range = cell_rows(2:79922)) %>%
  mutate(country = ifelse(country=="Slovakia", "Slovak Republic",
                          ifelse(country == "Czechia", "Czech Republic", 
                                 ifelse(country == "United Kingdom of Great Britain and Northern Ireland", "United Kingdom",
                                        ifelse(country == "Republic of Korea", "Korea",
                                               ifelse(country == "United States of America", "United States",country))))), gwh = as.numeric(gwh)) %>%
  fill(country, technology, on_off) %>%
  pivot_wider(id_cols = c(country, year), names_from = technology, values_from = gwh) %>%
  setNames(tolower(gsub(" ", "_", (names(.)))))

ongrid$total_gwh <- rowSums(as.matrix(ongrid[,3:20]), na.rm = TRUE)

offgrid <- read_xlsx(here("data", "raw", "ELECGEN_IRENA_OFFGRID.xlsx"), range = cell_rows(2:79922)) %>%
  mutate(country = ifelse(country=="Slovakia", "Slovak Republic",
                          ifelse(country == "Czechia", "Czech Republic", 
                                 ifelse(country == "United Kingdom of Great Britain and Northern Ireland", "United Kingdom",
                                        ifelse(country == "Republic of Korea", "Korea",
                                               ifelse(country == "United States of America", "United States",country))))), gwh = as.numeric(gwh)) %>%
  fill(country, technology, on_off) %>%
  pivot_wider(id_cols = c(country, year), names_from = technology, values_from = gwh) %>% 
  setNames(tolower(gsub(" ", "_", (names(.)))))

offgrid$total_gwh <- rowSums(as.matrix(offgrid[,3:20]), na.rm = TRUE)

gwh_on <- sum(select(ongrid, 3:20), na.rm = TRUE)
gwh_off <- sum(select(offgrid, 3:20), na.rm = TRUE)
gwh_on/(gwh_on + gwh_off)

# writexl::write_xlsx(ongrid, here("data/out/clean_elecgen_ongrid_irena_2000_19.xlsx"))
# writexl::write_xlsx(offgrid, here("data/out/clean_elecgen_offgrid_irena_2000_19.xlsx"))
#setdiff(c(EU31, OECD), unique(offgrid$country))

ongrid %>% pivot_longer(cols = 3:21, names_to = 'source', values_to = 'emissions') %>% 
  gen_hms(vars = names(ongrid[3:21]), ds = ., lab = 'source')

offgrid %>% pivot_longer(cols = 3:21, names_to = 'source', values_to = 'emissions') %>% 
  gen_hms(vars = names(offgrid[3:21]), ds = ., lab = 'source')

pdf("IRENA_plots.pdf")
ongrid %>% pivot_longer(cols = !c(country, year), values_drop_na = TRUE) %>% 
  filter(value > 0)  %>% 
  group_by(name) %>% 
  summarise(start = as.numeric(min(year)), end = as.numeric(max(year))) %>% 
  ggplot() +
    aes(y = name) +
    geom_segment(aes(x = start, 
                     xend = end,
                     yend = name,
                     color = name), 
                 size = 5,
                 show.legend = FALSE) +
  geom_text(aes(x = start, label = start), 
              nudge_x = 0,
              size = 3) +
 labs(title = "IRENA Ongrid Electricity Generation by Energy Source", subtitle = paste("Year coverage from 2000 to 2020")) +
  ylab("Energy Source") + xlab("Year")
 
ongrid %>% pivot_longer(cols = !c(country, year), values_drop_na = TRUE) %>% 
  filter(value > 0)  %>% 
  group_by(name, year) %>% 
  summarise(obs = n(), n_OECD = sum(country %in% c(EU31, OECD))) %>% 
  ggplot(., aes(x = year)) + 
  geom_col(aes(y = obs, fill = "blue")) +
  geom_col(aes(y = n_OECD, fill = "green")) +
  geom_hline(yintercept = 43, linetype = "dashed") +
  facet_wrap(~name) +
  theme(legend.position = "none") +
  labs(title = "IRENA Ongrid Electricity Generation by Energy Source", subtitle = "Country coverage from 2000 to 2020.")

ongrid %>% pivot_longer(cols = !c(country, year), values_drop_na = TRUE) %>% 
  ggplot(aes(x = year, y = value, group = country)) +
  geom_line(aes(fill= country)) +
  facet_wrap(~name, scales = "free") +
  labs(title = "IRENA Ongrid Electricity Generation by Energy Source", subtitle = "Country generation statistics from 2000 to 2020.")

dev.off()

```

## OWID Emissions by sector

Annual greenhouse gas emissions by sector by country 1990 - 2018

https://ourworldindata.org/emissions-by-sector#annual-greenhouse-gas-emissions-by-sector
Greenhouse gas emissions from other fuel combustion, measured in tonnes of
carbon dioxide-equivalents.

Aggregated from CAIT Climate Data Explorer via Climate Watch

Our complete CO2 and Greenhouse Gas Emissions dataset is a collection of key metrics maintained by Our World in Data. It is updated regularly and includes data on CO2 emissions (annual, per capita, cumulative and consumption-based), other greenhouse gases, energy mix, and other relevant metrics.

The following "ghg-emissions-by-sector.csv" contains emissions by each sector (similar to in EDGAR).

https://github.com/owid/co2-data

```{r}
sector <- read.csv(here("data", "raw", "ghg-emissions-by-sector.csv")) %>%
  tibble() %>% 
  select(-2) %>% 
  setNames(tolower(gsub("[[:punct:]]and", "", 
                        gsub("energy", "", c("country", names(.)[2:13]))))) %>% 
  mutate(country = ifelse(country == "Czechia", "Czech Republic",
                                 ifelse(country == "South Korea", "Korea",
                                        ifelse(country == "Slovakia", "Slovak Republic", country))))


#writexl::write_xlsx(sector, here("data", "out","owid_ghg_emissions_by_sector.xlsx"))
#setdiff(c(EU31, OECD), unique(sector$country))

sector %>% pivot_longer(cols = !c(country, year), names_to = "sector", values_to = "emissions") %>% 
  gen_hms(names(sector[3:13]), ., 'sector')

pdf("OWID_emissions_by_sector_plots.pdf")
sector %>% pivot_longer(cols = !c(country, year), values_drop_na = TRUE) %>% 
  filter(value > 0)  %>% 
  group_by(name) %>% 
  summarise(start = as.numeric(min(year)), end = as.numeric(max(year))) %>% 
  ggplot() +
    aes(y = name) +
    geom_segment(aes(x = start, 
                     xend = end,
                     yend = name,
                     color = name), 
                 size = 5,
                 show.legend = FALSE) +
  geom_text(aes(x = start, label = start), 
              nudge_x = 0,
              size = 3) +
 labs(title = "OWID Emissions by Sector", subtitle = paste("Year coverage from 1990 to 2018")) +
  ylab("Sector") + xlab("Year")
 
sector %>% pivot_longer(cols = !c(country, year), values_drop_na = TRUE) %>% 
  filter(value > 0)  %>% 
  group_by(name, year) %>% 
  summarise(obs = n(), n_OECD = sum(country %in% c(EU31, OECD))) %>% 
  ggplot(., aes(x = year)) + 
  geom_col(aes(y = obs, fill = "blue")) +
  geom_col(aes(y = n_OECD, fill = "green")) +
  geom_hline(yintercept = 43, linetype = "dashed") +
  facet_wrap(~name) +
  theme(legend.position = "none") +
  labs(title = "OWID Emissions by Sector", subtitle = "Country coverage from 1990 to 2018.")

sector %>% pivot_longer(cols = !c(country, year), values_drop_na = TRUE) %>% 
  ggplot(aes(x = year, y = value, group = country)) +
  geom_line(aes(fill= country)) +
  facet_wrap(~name, scales = "free") +
  labs(title = "OWID Emissions by Sector", subtitle = "Emissions statistics by sector and country.")
dev.off()
```

## OWID All indicators
Consumption data available for the following energy sources. 
All sources are measured in pct_change, twh_change, and total_consumption. 
Only coal, biofuel, fossil also have an indicator for consumption per capita. 
Would therefore recommend not using per capita numbers.:
- energy
- biofuel
- coal
- fossil
- gas
- gydro
- low carbon
- nuclear
- oil
- renewables
- other renewables
- solar
- wind

Energy share by source (1965-) has a longer time horizon than electricity share by source (1985 - ). 

```{r}
owid_all <- read_excel(here("data", "out", "owid_all.xlsx")) %>% 
  mutate(country = ifelse(country == "Czechia", "Czech Republic", ifelse(country == "Slovakia", "Slovak Republic", ifelse(country == "South Korea", "Korea",country))))

owid_all %>% pivot_longer(cols = !c(country, year, iso_code), names_to = 'sector_share', values_to = 'emissions') %>% gen_hms(vars = names(owid_all[4:28]), ds = ., lab = 'sector_share')

# lapply(unique(sub("\\_.*", "", names(owid_all))), function(x) grep(x, grep('share', names(owid_all), value = TRUE), value = TRUE))
# 
# setdiff(names(owid_all), c('country', 'iso_code', 'year', 'population', grep("cons|prod|share|elec_per_capita|electricity|energy_per_capita", names(owid_all), value = TRUE)))
# 
# grep("energy", names(owid_all), value = TRUE)

# sources <- c("coal", "gas", "oil", "hydro", "nuclear", "^biofuel", "solar", "hydro", "wind", "^renewables", "other_renewables", "fossil", "low_carbon","other_renewable")
# 
# for(i in 1:length(var_owid$name)){
#    s <- as.character(unlist(lapply(sources, function (x) x[grepl(x, var_owid$name[i])])))
#    if(length(s) == 0){var_owid$source[i] <- NA}else{name_owid$source[i] <- sub("\\^","",s)}
# }

# OWID All looking at energy and electricity shares by source
overview_owid <- owid_all %>%
  pivot_longer(cols = !c(country, year, iso_code), values_drop_na = TRUE) %>% 
  mutate(cat = case_when(grepl("per_capita|per_gdp|intensity", name) ~ "intensity",
         grepl("prod", name) ~ "production",
         grepl("cons", name) ~ "consumption",
         grepl("share_energy", name) ~ "share_energy",
         grepl("share_elec", name) ~ "share_electricity",
         grepl("electricity", name) ~ "electricity"))


cats <- unique(overview_owid$cat) %>% .[!is.na(.)]

plots <- list()
j = 0
for(i in 1:length(cats)){
 p1 <- overview_owid %>% filter(cat == cats[i]) %>% 
    filter(value > 0) %>% 
    group_by(name) %>% 
    summarise(start = min(year), end = max(year)) %>% 
    arrange(start) %>% 
    ggplot() +
      aes(y = name) +
      geom_segment(aes(x = start, 
                       xend = end,
                       yend = name,
                       color = name), 
                   size = 5,
                   show.legend = FALSE) +
    geom_text(aes(x = start, label = start), 
                nudge_x = 3,
                size = 3) +
    labs(title = paste("OWID",cats[i]), subtitle = "Time horizons from 1965 - 2020.") %>% print()
 j = j + 1
 plots[[j]] <- p1
p2 <- overview_owid %>% filter(cat == cats[i]) %>% 
  filter(value > 0) %>% 
  group_by(name, year) %>% 
  summarise(obs = n(), n_OECD = sum(country %in% c(EU31, OECD))) %>% 
  ggplot(., aes(x = year)) + 
  geom_col(aes(y = obs, fill = "blue")) +
  geom_col(aes(y = n_OECD, fill = "green")) +
  geom_hline(yintercept = 43, linetype = "dashed") +
  facet_wrap(~name) +
  theme(legend.position = "none") +
  labs(title = paste("OWID",cats[i]), subtitle = "Country coverage from 1965 - 2020.") %>% print()
j = j + 1
plots[[j]] <- p2
p3 <- overview_owid %>% filter(cat == cats[i]) %>% 
  ggplot(aes(x = year, y = value, group = country)) +
  geom_line(aes(fill= country)) +
  facet_wrap(~name, scales = "free") +
  labs(title = paste("OWID",cats[i]), subtitle = "Energy/electricity share statistics by source and country.") 
j = j + 1
plots[[j]] <- p3
}

pdf("OWID_all_plots.pdf")
for(k in 1:length(plots)){
  print(plots[[k]])
}
dev.off()


```
# IEA Emissions from FF by type and sector
WARNING: DATASET IS INCOMPLETE AFTER DOWNLOAD.
Provides annual emissions by country for CO2, methane, NOx, and CO2e for the categories of:
- Total
- Coal, peat, and oil shale
- Oil
- Natural gas
- Other
```{r}

iea_type_sector <- read_excel(here("data/raw/IEA_GHG_emissions_by fuel type _sector.xlsx"), 
    skip = 2) %>% remove_empty %>% clean_names %>% fill(country, time, product) %>%
     mutate_at(c(2,5:14), as.numeric)

# For now filter on CO2 and CO2e
j = 0
for(k in c("Carbon Dioxide", "Carbon Dioxide Equivalent")){
  for(m in c("Total","Coal, peat and oil shale","Oil","Natural gas","Other")){
    
  p <- iea_type_sector %>% 
  filter(gas == k, product == m) %>% 
  pivot_longer(cols = 5:14) %>% 
  group_by(name, product) %>% 
    summarise(start = min(time), end = max(time)) %>% 
    arrange(start) %>% 
    ggplot() +
      aes(y = name) +
      geom_segment(aes(x = start, 
                       xend = end,
                       yend = name,
                       color = name), 
                   size = 5,
                   show.legend = FALSE) +
    geom_text(aes(x = start, label = start), 
                nudge_x = 3,
                size = 3) +
    labs(title = paste("IEA",k,"Emissions from", m, "by Sector"), subtitle = "Time horizons from 1980 - 2020.")
    j = j + 1
 plots[[j]] <- p
 
p <- iea_type_sector %>% 
  filter(gas == k, product == m) %>% 
  pivot_longer(cols = 5:14) %>% 
  group_by(name, time) %>% 
  summarise(obs = n(), n_OECD = sum(country %in% c(EU31, OECD))) %>% 
  ggplot(., aes(x = time)) + 
  geom_col(aes(y = obs, fill = "blue")) +
  geom_col(aes(y = n_OECD, fill = "green")) +
  geom_hline(yintercept = 43, linetype = "dashed") +
  facet_wrap(~name) +
  theme(legend.position = "none") +
  labs(title = paste("IEA",k,"Emissions from", m, "by Sector"), subtitle = "Country coverage from 1980 - 2020.")
    j = j + 1
 plots[[j]] <- p
 
p <- iea_type_sector %>%  filter(gas == k, product == m) %>% 
  ggplot(aes(x = time, y = value, group = country)) +
  geom_line(aes(fill= country)) +
  facet_wrap(~name, scales = "free") +
 labs(title = paste("IEA",k,"Emissions from", m, "by Sector"), subtitle = "Country statistics from 1980 - 2020.") 
    j = j + 1
 plots[[j]] <- p
  }
}

```

# OECD Emissions percentages by sector
Skipped for now as it does not provide a super interesting insight. Relative 
emissions of different sectors not disaggreggated by source fluctuates.
"OECD_emissions_percentage_by_sector.xls"

# 
