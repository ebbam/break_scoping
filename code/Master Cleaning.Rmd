---
title: "Cleaning_all"
author: "Ebba Mark"
date: "`r Sys.Date()`"
output: html_document
---

## Introduction

Main file for cleaning and judging completeness/scope of various downloaded 
data files. Each chunk caters to one data file and, at this point, 
only produces heat maps for each relevant variable in a dataset.

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
library(conflicted)
library(data.table)
library(here)
library(tidyverse)
library(readxl)
library(openxlsx)
library(stringr)
library(janitor)
library(vtable)
conflict_prefer_all("dplyr", quiet = TRUE)

```

# Dictionaries and functions
```{r}

source(here("code/dicts.R"))

```

## IRENA: Electricity generation, capacity, fuel share of electricity generation and capacity {.tabset}
Multiple datasets about capacity, generation, offgrid and ongrid generation by source, renewable share of electricity and capacity

IRENA (2021), Renewable energy statistics 2021, International Renewable
Energy Agency (IRENA), Abu Dhabi

Electricity generation (GWh) is the gross electricity produced by electricity
plants, combined heat and power plants (CHP) and distributed generators measured
at the output terminals of generation. It includes on-grid and off-grid generation,
and it also includes the electricity self-consumed in energy industries; not
only the electricity fed into the grid (net electricity production).

### Dataset
```{r}
################################################################################
# Electricity generation (GWh) by Country/area, Technology, Grid connection and Year
ongrid <- read_xlsx(here("data", "raw", "Elec_gen_capacity", "ELECGEN_IRENA_ONGRID.xlsx"), range = cell_rows(2:79922)) %>%
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country), 
         ongrid_elecgen_gwh = as.numeric(gwh)) %>%
  fill(country, technology, on_off) %>%
   select(-c(on_off, gwh)) # %>% 
  # pivot_wider(id_cols = c(country, year), names_from = technology, values_from = gwh) %>%
  # setNames(tolower(gsub(" ", "_", (names(.)))))

# Electricity generation (GWh) by Country/area, Technology, Grid connection and Year
offgrid <- read_xlsx(here("data", "raw", "Elec_gen_capacity", "ELECGEN_IRENA_OFFGRID.xlsx"), range = cell_rows(2:79922)) %>%
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country), offgrid_elecgen_gwh = as.numeric(gwh)) %>%
  fill(country, technology, on_off) %>%
  select(-c(on_off, gwh)) # %>% 
  # pivot_wider(id_cols = c(country, year), names_from = technology, values_from = gwh) %>% 
  # setNames(tolower(gsub(" ", "_", (names(.)))))

elec_gen <- left_join(ongrid, offgrid, by = c('year', 'country', 'technology')) %>%
  rename(source = technology) %>% 
  #mutate(country = ifelse(country == "Kosovo*", "Kosovo", country)) %>% 
  rowwise() %>% 
  mutate(tot_elecgen_gwh = sum(ongrid_elecgen_gwh, offgrid_elecgen_gwh, na.rm = TRUE), year = as.numeric(year)) %>% ungroup

rm(ongrid)
rm(offgrid)
# setdiff(offgrid$technology, ongrid$technology)

# # Retained variables: elec_gen
# - Country
# - Year
# - Source
# - Offgrid electricity capacity Mw
# - Ongrid electricity capacity Mw
# - Total electricity capacity Mw

################################################################################
# Installed electricity capacity by country/area (MW) by Country/area, Technology, ONGRID connection and Year
elec_cap_ongrid <- read_xlsx(here("data", "raw", "Elec_gen_capacity", "ELECCAP_ONGRID.xlsx"), 
                             range = cell_rows(3:92798), 
                             col_names = c("country", "source", "grid", "year", "ongrid_eleccap_mw"), 
                             col_types = c("text", "text", "text", "numeric", "numeric")) %>% 
  fill(country, source, grid) %>% 
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country)) %>% select(-grid)


# Installed electricity capacity by country/area (MW) by Country/area, Technology, OFFGRID connection and Year
elec_cap_offgrid <- read_xlsx(here("data", "raw", "Elec_gen_capacity", "ELECCAP_OFFGRID.xlsx"), 
                              range = cell_rows(3:92798), col_names = c("country", "source", "grid", "year", "offgrid_eleccap_mw"), col_types = c("text", "text", "text", "numeric", "numeric")) %>% 
  fill(country, source, grid) %>% 
   mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country), 
          offgrid_eleccap_mw = as.numeric(offgrid_eleccap_mw)) %>% 
  select(-grid)
  
test_diff(elec_cap_ongrid, elec_cap_offgrid, c("country", "source", "year"))
                     
elec_cap <- left_join(elec_cap_offgrid, elec_cap_ongrid, by = c("country", "source", "year")) %>% 
  rowwise() %>%  
  mutate(tot_eleccap_mw = sum(offgrid_eleccap_mw, ongrid_eleccap_mw, na.rm= TRUE)) %>% ungroup()

rm(elec_cap_offgrid)
rm(elec_cap_ongrid)
################################################################################
# Merged capacity and generation
elec <- full_join(elec_cap, elec_gen, by = c("country", "source", "year"))
rm(elec_cap)
rm(elec_gen)
################################################################################
# Installed renewable electricity capacity (MW) by Region/country/area, Technology and Year
# 239 countries
re_eleccap <- read_xlsx(here("data", "raw", "Elec_gen_capacity", "RE-ELECCAP_20220908-084826.xlsx"), range = cell_rows(3:4544)) %>%
  rename(country = `...1`, source = `...2`) %>% 
  fill(country) %>%
  pivot_longer(!c(country, source), names_to = "year", values_to = "inst_re_cap_mw") %>% 
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country), inst_re_cap_mw = as.numeric(inst_re_cap_mw), year = as.numeric(year))

################################################################################
# Renewable Electricity generation (GWh) by Region/country/area, Technology and Year
# 239 countries
re_elecgen <- read_xlsx(here("data", "raw", "Elec_gen_capacity", "RE-ELECGEN_20220908-084850.xlsx"), range = cell_rows(3:4734)) %>% 
  rename(country = `...1`, source = `...2`) %>% 
  fill(country) %>%
  filter(!(country %in% c("World","Africa","C America + Carib","Eurasia","Europe","EU 27","Middle East","N America","Oceania","S America"))) %>% 
  pivot_longer(!c(country, source), names_to = "year", values_to = "re_elecgen_gwh") %>% 
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country), year = as.numeric(year))

test_diff(re_eleccap, re_elecgen,c('country', 'source', 'year'))
re_capgen <- full_join(re_eleccap, re_elecgen, by = c('country', 'source', 'year'))

rm(re_eleccap)
rm(re_elecgen)
################################################################################
# Renewable energy share of electricity capacity and generation (%) by Region/country/area, Indicator and Year
# 234 countries
re_share_elec <- read_xlsx(here("data", "raw", "Elec_gen_capacity", "RESHARE_20220908-084915.xlsx"), range = cell_rows(3:471)) %>% 
  rename(country = `...1`, indicator = `...2`) %>% 
  fill(country) %>%
  pivot_longer(!c(country, indicator), values_transform = as.numeric, names_to = "year") %>% 
  pivot_wider(names_from = indicator, values_from = value) %>% 
  rename(re_share_eleccap_pct = `RE share of electricity capacity (%)`, re_share_elecgen_pct = `RE share of electricity generation (%)`) %>% 
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country))


# Combining re_share_elec, elec
elec_panel <- elec %>% 
  group_by(country, year) %>% 
  summarize(offgrid_cap_mw = sum(offgrid_eleccap_mw, na.rm = TRUE),
            ongrid_cap_mw = sum(ongrid_eleccap_mw, na.rm = TRUE),
            tot_cap_mw = sum(tot_eleccap_mw, na.rm = TRUE),
            ongrid_gen_gwh = sum(ongrid_elecgen_gwh, na.rm = TRUE), 
            offgrid_gen_gwh = sum(offgrid_elecgen_gwh, na.rm = TRUE), 
            tot_gen_gwh = sum(tot_elecgen_gwh, na.rm = TRUE)) %>% ungroup()
rm(elec)

re_panel <- re_capgen %>% 
  filter(source == "Total renewable energy" & country != "Asia") %>% 
  select(-source)

rm(re_capgen)
                    
re_share_panel <- re_share_elec %>% 
  filter(!(country %in% c("World", "North America", "Middle East", "South America", 
                          "Africa", "Eurasia", "Europe", "European Union", "Central America and the Caribbean", 
                          "Asia", "Oceania"))) %>% 
  mutate(year = as.numeric(year))

rm(re_share_elec)

test_diff(elec_panel, re_panel, c('country', 'year'))
test_diff(elec_panel, re_share_panel, c('country', 'year'))
test_diff(re_panel, re_share_panel, c('country', 'year'))

tot_elec_panel <- left_join(re_panel, elec_panel, by = c('country', 'year')) %>% left_join(., re_share_panel, by = c('country', 'year')) %>% tibble()
rm(re_panel)
rm(elec_panel)
rm(re_share_panel)
labs <- data.frame(varnames = names(tot_elec_panel),
varlabels = c('country', 'year', "installed renewable energy capacity (mw)", "renewable electricity generation (gwh)", "offgrid electricity capacity (mw)", "ongrid electricity capacity (mw)", "total electricity capacity (mw)", "ongrid electricity generation (gwh)", "offgrid electricity generation (gwh)", "total electricity generation (gwh)", "renewable share of electricity capacity (%)", "renewable share of electricity generation (%)"))

#vtable(tot_elec_panel, labels = labs, opts = opts)

#opts = c(country = NA)
#write_csv(tot_elec_panel, here("data/temp/elecgencap_re_share_IRENA.csv"))

```


### Plots
```{r IRENA Elec gen, eval = FALSE, echo=FALSE}

# pdf("IRENA_plots.pdf")
ongrid %>% pivot_longer(cols = !c(country, year), values_drop_na = TRUE) %>% 
  filter(value > 0)  %>% 
  group_by(name) %>% 
  summarise(start = as.numeric(min(year)), end = as.numeric(max(year))) %>% 
  ggplot() +
    aes(y = name) +
    geom_segment(aes(x = start, 
                     xend = end,
                     yend = name,
                     color = name), 
                 size = 5,
                 show.legend = FALSE) +
  geom_text(aes(x = start, label = start), 
              nudge_x = 0,
              size = 3) +
 labs(title = "IRENA Ongrid Electricity Generation by Energy Source", subtitle = paste("Year coverage from 2000 to 2020")) +
  ylab("Energy Source") + xlab("Year")
 
ongrid %>% pivot_longer(cols = !c(country, year), values_drop_na = TRUE) %>% 
  filter(value > 0)  %>% 
  group_by(name, year) %>% 
  summarise(obs = n(), n_OECD = sum(country %in% c(EU31, OECD))) %>% 
  ggplot(., aes(x = year)) + 
  geom_col(aes(y = obs, fill = "blue")) +
  geom_col(aes(y = n_OECD, fill = "green")) +
  geom_hline(yintercept = 43, linetype = "dashed") +
  facet_wrap(~name) +
  theme(legend.position = "none") +
  labs(title = "IRENA Ongrid Electricity Generation by Energy Source", subtitle = "Country coverage from 2000 to 2020.")

ongrid %>% pivot_longer(cols = !c(country, year), values_drop_na = TRUE) %>% 
  ggplot(aes(x = year, y = value, group = country)) +
  geom_line(aes(fill= country)) +
  facet_wrap(~name, scales = "free") +
  labs(title = "IRENA Ongrid Electricity Generation by Energy Source", subtitle = "Country generation statistics from 2000 to 2020.")

# dev.off()

```


## BP Stats Review {.tabset}

For now, all variables are retained
electfuel: total (KEEP), coal (KEEP), gas (KEEP), [hydro], [nuclear], oil (KEEP), other (KEEP)
- twh: biogeo, hydro (KEEP), nuclear(KEEP), ren power, solar, wind
- twh_net: biogeo, hydro, nuclear, ren power, solar, wind
- twh > electfuel
- twh ?? twh_net
### Dataset
```{r}
#tot_elec_panel <- read_csv(here("data/temp/elecgencap_re_share_IRENA.csv"))

bp <- read_excel(here("data/raw/bp-stats-review-2022-consolidated-dataset-panel-format.xlsx")) %>%
  filter(!((Country == "Russian Federation" & Year < 1985) | (Country == "USSR" & Year >= 1985))) %>% 
  mutate(country = ifelse(Country %in% names(getcountry), unname(getcountry[Country]),
                          ifelse(Country == "USSR", "Russia", Country)),
         year = Year) %>% 
  arrange(country, year) %>% 
    select(country, year, pop, EU, OECD, starts_with("co2_"), starts_with("elect"), contains("twh")) %>% 
  filter(!grepl("Other", country) & !grepl("Total", country) & country != "Rest of World") 

tot_elec_panel_bp <- full_join(tot_elec_panel, bp, by = c("country", "year"))
rm(tot_elec_panel)
rm(bp)
##write_xl::write_xlsx(tot_elec_panel_bp, here("data/temp/elec_bp.xlsx"))
 
```

## EDGAR V6.0 {.tabset}
### Dataset
Issue: Serbia and Montenegro are combined in this dataset....
```{r}

edgar_full <- read_excel(here("data", "raw", "v60_CO2_excl_short-cycle_org_C_1970_2018.xls"), skip = 9) %>%
  pivot_longer(cols = starts_with("Y_"), names_to = "year", values_to = "emissions") %>% 
  clean_names() %>% 
  mutate(year=as.numeric(str_remove(year, "Y_")), emissions = as.numeric(emissions)) %>% 
  rename(country = name, ipcc_code = ipcc_code_2006_for_standard_report, ipcc_code_name = ipcc_code_2006_for_standard_report_name) %>% 
  select(-c_group_im24_sh) %>% 
  filter(country != "Int. Shipping" & country != "Int. Aviation") %>% 
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country))

# Create a panel with all sectors: country - year - sector
# write.xlsx(edgar_full, here("data/temp/edgar_panel_full.xlsx"))

edgar <- edgar_full %>% 
  filter(ipcc_code == "1.A.1.a") %>% 
  select(country, year, emissions) %>% 
  rename(edgar_elec_emissions = emissions)
test_diff(tot_elec_panel_bp, edgar, c("country", "year"))

rm(edgar_full)

edgar_elec_temp <- full_join(edgar, tot_elec_panel_bp, by = c("country", "year"))
rm(edgar)
rm(tot_elec_panel_bp)
#write.xlsx(edgar_elec_temp, here("data/temp/edgar_elec_temp.xlsx"))

```

### Plots
```{r, eval = FALSE}
#pdf("EDGAR_plots.pdf")
edgar %>% select(country, year, ipcc_code, ipcc_code_name, emissions) %>% 
  filter(emissions > 0) %>% 
  group_by(ipcc_code_name) %>% 
  summarise(start = min(year), end = max(year)) %>% 
  ggplot() +
    aes(y = ipcc_code_name) +
    geom_segment(aes(x = start, 
                     xend = end,
                     yend = ipcc_code_name,
                     color = ipcc_code_name), 
                 size = 5,
                 show.legend = FALSE) +
  geom_text(aes(x = start, label = start), 
              nudge_x = 3,
              size = 3) +
 labs(title = "EDGAR v6.0 Emissions data by sector", subtitle = paste("Year coverage from 1970 to 2020"))
 
edgar %>% select(country, year, ipcc_code, ipcc_code_name, emissions) %>% 
  filter(emissions > 0) %>% 
  group_by(ipcc_code_name, year) %>% 
  summarise(obs = n(), n_OECD = sum(country %in% c(EU31, OECD))) %>% 
  ggplot(., aes(x = year)) + 
  geom_col(aes(y = obs, fill = "blue")) +
  geom_col(aes(y = n_OECD, fill = "green")) +
  geom_hline(yintercept = 43, linetype = "dashed") +
  facet_wrap(~ipcc_code_name) +
  theme(legend.position = "none") +
  labs(title = "EDGAR v6.0 Emissions data by sector", subtitle = "Country coverage from 1970 to 2020.")

edgar %>% select(country, year, ipcc_code, ipcc_code_name, emissions) %>% 
  #group_by(as.factor(country), ipcc_code_name) %>% 
  ggplot(aes(x = year, y = emissions)) +
  geom_line(aes(fill = country)) +
  facet_wrap(~ipcc_code_name, scales = "free") +
    labs(title = "EDGAR v6.0 Emissions data by sector", subtitle = "Emissions statistics by country from 1970 to 2020.")

#dev.off()
```

## OWID Emissions by sector {.tabset}

Annual greenhouse gas emissions by sector by country 1990 - 2018

https://ourworldindata.org/emissions-by-sector#annual-greenhouse-gas-emissions-by-sector
Greenhouse gas emissions from other fuel combustion, measured in tonnes of
carbon dioxide-equivalents.

Aggregated from CAIT Climate Data Explorer via Climate Watch

Our complete CO2 and Greenhouse Gas Emissions dataset is a collection of key metrics maintained by Our World in Data. It is updated regularly and includes data on CO2 emissions (annual, per capita, cumulative and consumption-based), other greenhouse gases, energy mix, and other relevant metrics.

The following "ghg-emissions-by-sector.csv" contains emissions by each sector (similar to in EDGAR).

https://github.com/owid/co2-data

### Dataset
```{r}

#edgar_elec_temp <- read.xlsx(here("data/temp/edgar_elec_temp.xlsx")) %>% tibble()

owid_full <- read.csv(here("data", "raw", "ghg-emissions-by-sector.csv")) %>%
  tibble() %>% 
  select(-2) %>% 
  setNames(tolower(gsub("[[:punct:]]and", "", 
                        gsub("energy", "", c("country", names(.)[2:13]))))) %>% 
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country)) %>% 
  filter(country != "European Union (27)" & country != "World")

# save full sectoral panel
#write.xlsx(owid_full, here("data/temp/owid_emissions_by_sector_full_panel.xlsx"))

owid_elec <- owid_full %>% 
  select(country, year, electricity.heat) %>% 
  rename(owid_elec_emissions = electricity.heat)
test_diff(edgar_elec_temp, owid_elec, c("country", "year"))

elec_temp <- left_join(edgar_elec_temp, owid_elec, by = c("country", "year"))
rm(edgar_elec_temp)
rm(owid_elec)
#write.xlsx(elec_temp, here("data/temp/elec_edgar_owid.xlsx"))

```


### Plots
```{r, eval = FALSE}

#pdf("OWID_emissions_by_sector_plots.pdf")
owid_full %>% pivot_longer(cols = !c(country, year), values_drop_na = TRUE) %>% 
  filter(value > 0)  %>% 
  group_by(name) %>% 
  summarise(start = as.numeric(min(year)), end = as.numeric(max(year))) %>% 
  ggplot() +
    aes(y = name) +
    geom_segment(aes(x = start, 
                     xend = end,
                     yend = name,
                     color = name), 
                 size = 5,
                 show.legend = FALSE) +
  geom_text(aes(x = start, label = start), 
              nudge_x = 0,
              size = 3) +
 labs(title = "OWID Emissions by Sector", subtitle = paste("Year coverage from 1990 to 2018")) +
  ylab("Sector") + xlab("Year")
 
owid_full %>% pivot_longer(cols = !c(country, year), values_drop_na = TRUE) %>% 
  filter(value > 0)  %>% 
  group_by(name, year) %>% 
  summarise(obs = n(), n_OECD = sum(country %in% c(EU31, OECD))) %>% 
  ggplot(., aes(x = year)) + 
  geom_col(aes(y = obs, fill = "blue")) +
  geom_col(aes(y = n_OECD, fill = "green")) +
  geom_hline(yintercept = 43, linetype = "dashed") +
  facet_wrap(~name) +
  theme(legend.position = "none") +
  labs(title = "OWID Emissions by Sector", subtitle = "Country coverage from 1990 to 2018.")

owid_full %>% pivot_longer(cols = !c(country, year), values_drop_na = TRUE) %>% 
  ggplot(aes(x = year, y = value, group = country)) +
  geom_line(aes(fill= country)) +
  facet_wrap(~name, scales = "free") +
  labs(title = "OWID Emissions by Sector", subtitle = "Emissions statistics by sector and country.")

#dev.off()
```


## OWID All indicators {.tabset}
Consumption data available for the following energy sources. 
All sources are measured in pct_change, twh_change, and total_consumption. 
Only coal, biofuel, fossil also have an indicator for consumption per capita. 
Would therefore recommend not using per capita numbers.:
- energy
- biofuel
- coal
- fossil
- gas
- gydro
- low carbon
- nuclear
- oil
- renewables
- other renewables
- solar
- wind

Energy share by source (1965-) has a longer time horizon than electricity share by source (1985 - ). 

### Dataset
```{r}
#elec_temp <- read.xlsx(here("data/temp/elec_edgar_owid.xlsx"))

owid_all <- read_excel(here("data", "temp", "owid_all.xlsx"))

owid_elec <- owid_all %>% 
  select(country, year, population, gdp, electricity_generation, electricity_demand, 
         greenhouse_gas_emissions, per_capita_electricity, energy_cons_change_pct, 
         energy_cons_change_twh, carbon_intensity_elec, primary_energy_consumption,
         energy_per_gdp, energy_per_capita, net_elec_imports_share_demand,
         net_elec_imports, contains("low_carbon"), contains("renewable"), 
         contains("fossil")) %>% mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country)) %>% 
  mutate(country = ifelse(country == "USSR" & year < 1985, "Russia", ifelse(country == "Taiwan", "Chinese Taipei", country))) %>% 
  filter(!(country %in% c("Africa", "Antarctica", "Asia Pacific", "Eastern Africa", "Europe", "European Union (27)", "Hawaiian Trade Zone", "Middle Africa", "Middle East", "Non-OECD", "OECD", "U.S. Territories", "Western Africa", "World", "Yugoslavia", "Czechoslovakia", "U.S. Pacific Islands", "East Germany", "West Germany", "CIS", "Wake Island", "USSR")) & year >= 1965)

test_diff(owid_elec, elec_temp, c("country", "year"))
elec_temp <- left_join(elec_temp, owid_elec, by = c("country", "year"))
rm(owid_elec)
#write.xlsx(elec_temp, here("data/temp/elec_edgar_owid_all.xlsx"))
```

### Plots
```{r, eval = FALSE}
# OWID All looking at energy and electricity shares by source
overview_owid <- owid_all %>%
  pivot_longer(cols = !c(country, year, iso_code), values_drop_na = TRUE) %>% 
  mutate(cat = case_when(grepl("per_capita|per_gdp|intensity", name) ~ "intensity",
         grepl("prod", name) ~ "production",
         grepl("cons", name) ~ "consumption",
         grepl("share_energy", name) ~ "share_energy",
         grepl("share_elec", name) ~ "share_electricity",
         grepl("electricity", name) ~ "electricity"))


cats <- unique(overview_owid$cat) %>% .[!is.na(.)]

plots <- list()
j = 0
for(i in 1:length(cats)){
 p1 <- overview_owid %>% filter(cat == cats[i]) %>% 
    filter(value > 0) %>% 
    group_by(name) %>% 
    summarise(start = min(year), end = max(year)) %>% 
    arrange(start) %>% 
    ggplot() +
      aes(y = name) +
      geom_segment(aes(x = start, 
                       xend = end,
                       yend = name,
                       color = name), 
                   size = 5,
                   show.legend = FALSE) +
    geom_text(aes(x = start, label = start), 
                nudge_x = 3,
                size = 3) +
    labs(title = paste("OWID",cats[i]), subtitle = "Time horizons from 1965 - 2020.") %>% print()
 j = j + 1
 plots[[j]] <- p1
p2 <- overview_owid %>% filter(cat == cats[i]) %>% 
  filter(value > 0) %>% 
  group_by(name, year) %>% 
  summarise(obs = n(), n_OECD = sum(country %in% c(EU31, OECD))) %>% 
  ggplot(., aes(x = year)) + 
  geom_col(aes(y = obs, fill = "blue")) +
  geom_col(aes(y = n_OECD, fill = "green")) +
  geom_hline(yintercept = 43, linetype = "dashed") +
  facet_wrap(~name) +
  theme(legend.position = "none") +
  labs(title = paste("OWID",cats[i]), subtitle = "Country coverage from 1965 - 2020.") %>% print()
j = j + 1
plots[[j]] <- p2
p3 <- overview_owid %>% filter(cat == cats[i]) %>% 
  ggplot(aes(x = year, y = value, group = country)) +
  geom_line(aes(fill= country)) +
  facet_wrap(~name, scales = "free") +
  labs(title = paste("OWID",cats[i]), subtitle = "Energy/electricity share statistics by source and country.") 
j = j + 1
plots[[j]] <- p3
}

#pdf("OWID_all_plots.pdf")
for(k in 1:length(plots)){
  print(plots[[k]])
}
#dev.off()
```

# IEA Emissions allocation to electricity and heat
```{r}

#elec_temp <- read_excel(here("data/temp/elec_edgar_owid_all.xlsx"))

iea_elec <- read_excel(here("data/raw/IEA_emissions_electricity_heat_full.xlsx"), range = cell_rows(4:5943), 
           col_names = c("country", "year", "none", "elec_heat_emissions_ktco2", "elec_heat_emissions_kgco2_pc")) %>%
  select(-none) %>%
  fill(country) %>% 
  filter(!country %in% c("World","World aviation bunkers","World marine bunkers",
                         "Africa","Other Africa","Middle East","OECD Americas",
                         "Non-OECD Americas","Other non-OECD Americas","OECD Asia Oceania",
                         "Non-OECD Asia (excluding China)","Other non-OECD Asia","OECD Europe",
                         "Non-OECD Europe and Eurasia", "Former Soviet Union (if no detail)", 
                         "Former Yugoslavia (if no detail)","Memo: IEA Total",
                         "Memo: IEA and Accession/Association countries","Memo: OECD Total",
                         "Memo: Non-OECD Total","Memo: Africa (UN)","Memo: Americas (UN)",
                         "Memo: Asia (UN)","Memo: Europe (UN)","Memo: Oceania (UN)",
                         "Memo: ASEAN","Memo: European Union-27","Memo: European Union-28",
                         "Memo: FSU 15","Memo: G20","Memo: G7","Memo: G8","Memo: OPEC",
                         "Memo: Annex B Kyoto Parties","Memo: Annex I EIT","Memo: Annex I Parties",
                         "Memo: non-Annex I Parties", "Memo: Annex II Asia Oceania",
                         "Memo: Annex II Europe","Memo: Annex II North America","Memo: Annex II Parties",
                         "China (P.R. of China and Hong Kong, China)", 
                         "Memo: Former Yugoslavia")) %>% 
  mutate(across('country', str_replace, 'Memo: ', '')) %>% 
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country),
         year = as.numeric(year),
         elec_heat_emissions_ktco2 = as.numeric(elec_heat_emissions_ktco2),
         elec_heat_emissions_kgco2_pc = as.numeric(elec_heat_emissions_kgco2_pc))

test_diff(iea_elec, elec_temp, c("country", "year"))

elec_temp <- left_join(elec_temp, iea_elec, by = c("country", "year"))
rm(iea_elec)
#write.xlsx(elec_temp, here("data", "out", "elec_temp_iea.xlsx"))

```

# Population statistics
```{r}
#iea_elec <- read_excel(here("data", "out", "elec_temp_iea.xlsx"))

pop_stats <- read.csv(here("data/raw/WB_pop_stats.csv"), nrows = 9114) %>% select(1,3,5) %>% 
  rename(year = Time, country = Country.Name, population_wb = `Population..total..SP.POP.TOTL.`) %>% 
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country))

gdp_stats <- read.csv(here("data/raw/WB_GDP.csv"), nrows = 9114) %>% 
  select(1,3,5,6) %>% 
  rename(year = Time, country = Country.Name, wb_gdp = 3, wb_gdppc = 4) %>% 
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country), year = as.numeric(year), wb_gdp  = as.numeric(wb_gdp), wb_gdppc = as.numeric(wb_gdppc)) 

full <- left_join(pop_stats, gdp_stats, by = c("country", "year")) %>% 
  filter(!(country %in% c("Channel Islands", "Isle of Man"))) %>% 
  left_join(elec_temp, ., by = c("country", "year"))

rm(pop_stats)
rm(gdp_stats)
rm(owid_all)
rm(owid_full)
rm(elec_temp)

#saveRDS(full, here("data/out/elec_emissions_panel.RDS"))
tester <- readRDS(here("data/out/elec_emissions_panel.RDS"))
identical(unlist(tester), unlist(full))
rm(tester)

```

