---
title: "Cleaning_all"
author: "Ebba Mark"
date: "`r Sys.Date()`"
output: html_document
---

## Introduction

Main file for cleaning and judging completeness/scope of various downloaded 
data files. Each chunk caters to one data file with accompanying description of selected indicators

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
library(conflicted)
library(data.table)
library(here)
library(tidyverse)
library(readxl)
library(openxlsx)
library(stringr)
library(janitor)
library(plm)
library(pdftools)
conflict_prefer_all("dplyr", quiet = TRUE)

```

# Dictionaries and functions
```{r}

source(here("code/dicts.R"))

```

## IRENA: Electricity generation, capacity, fuel share of electricity generation and capacity
Multiple datasets about capacity, generation, offgrid and ongrid generation by source, renewable share of electricity and capacity

IRENA (2021), Renewable energy statistics 2021, International Renewable
Energy Agency (IRENA), Abu Dhabi

*Electricity generation* (GWh) is the gross electricity produced by electricity
plants, combined heat and power plants (CHP) and distributed generators measured
at the output terminals of generation. It includes on-grid and off-grid generation,
and it also includes the electricity self-consumed in energy industries; not
only the electricity fed into the grid (net electricity production).

The *renewable power capacity* data shown in these tables represents the maximum net generating capacity of power plants and other installations that use renewable energy sources to produce electricity.

Renewable: Hydropower (renewable + pumped storage), Marine, Wind (onshore + offshore), Solar (PV + concentrated), Bioenergy (solid (bagasse, renewable municipal waste, other solids) + liquid + biogas), geothermal

Retained variables: elec_gen
- Country
- Year
- Installed renewable capacity (Mw)
- Renewable electricity generation (gwh)
- Offgrid electricity capacity (Mw)
- Ongrid electricity capacity (Mw)
- Total electricity capacity (Mw)
- Ongrid electricity generation (gwh)
- Offgrid electricity generation (gwh)
- Total electrciity generation (gwh)
- Renewable share of electricity capacity (%)
- Renewable share of electricity generation (%)


```{r}
################################################################################
# Electricity generation (GWh) by Country/area, Technology, Grid connection and Year
ongrid <- read_xlsx(here("data", "raw", "Elec_gen_capacity", "ELECGEN_IRENA_ONGRID.xlsx"), range = cell_rows(2:79922)) %>%
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country), 
         ongrid_elecgen_gwh = as.numeric(gwh)) %>%
  fill(country, technology, on_off) %>%
   select(-c(on_off, gwh))

# Electricity generation (GWh) by Country/area, Technology, Grid connection and Year
offgrid <- read_xlsx(here("data", "raw", "Elec_gen_capacity", "ELECGEN_IRENA_OFFGRID.xlsx"), range = cell_rows(2:79922)) %>%
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country), offgrid_elecgen_gwh = as.numeric(gwh)) %>%
  fill(country, technology, on_off) %>%
  select(-c(on_off, gwh))

elec_gen <- left_join(ongrid, offgrid, by = c('year', 'country', 'technology')) %>%
  rename(source = technology) %>% 
  rowwise() %>% 
  mutate(tot_elecgen_gwh = sum(ongrid_elecgen_gwh, offgrid_elecgen_gwh, na.rm = TRUE), year = as.numeric(year)) %>% ungroup

rm(ongrid)
rm(offgrid)

################################################################################
# Installed electricity capacity by country/area (MW) by Country/area, Technology, ONGRID connection and Year
elec_cap_ongrid <- read_xlsx(here("data", "raw", "Elec_gen_capacity", "ELECCAP_ONGRID.xlsx"), 
                             range = cell_rows(3:92798), 
                             col_names = c("country", "source", "grid", "year", "ongrid_eleccap_mw"), 
                             col_types = c("text", "text", "text", "numeric", "numeric")) %>% 
  fill(country, source, grid) %>% 
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country)) %>% select(-grid)


# Installed electricity capacity by country/area (MW) by Country/area, Technology, OFFGRID connection and Year
elec_cap_offgrid <- read_xlsx(here("data", "raw", "Elec_gen_capacity", "ELECCAP_OFFGRID.xlsx"), 
                              range = cell_rows(3:92798), col_names = c("country", "source", "grid", "year", "offgrid_eleccap_mw"), col_types = c("text", "text", "text", "numeric", "numeric")) %>% 
  fill(country, source, grid) %>% 
   mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country), 
          offgrid_eleccap_mw = as.numeric(offgrid_eleccap_mw)) %>% 
  select(-grid)
  
test_diff(elec_cap_ongrid, elec_cap_offgrid, c("country", "source", "year"))
                     
elec_cap <- left_join(elec_cap_offgrid, elec_cap_ongrid, by = c("country", "source", "year")) %>% 
  rowwise() %>%  
  mutate(tot_eleccap_mw = sum(offgrid_eleccap_mw, ongrid_eleccap_mw, na.rm= TRUE)) %>% ungroup()

rm(elec_cap_offgrid)
rm(elec_cap_ongrid)
################################################################################
# Merged capacity and generation
elec <- full_join(elec_cap, elec_gen, by = c("country", "source", "year"))
rm(elec_cap)
rm(elec_gen)
################################################################################
# Installed renewable electricity capacity (MW) by Region/country/area, Technology and Year
# 239 countries
re_eleccap <- read_xlsx(here("data", "raw", "Elec_gen_capacity", "RE-ELECCAP_20220908-084826.xlsx"), range = cell_rows(3:4544)) %>%
  rename(country = `...1`, source = `...2`) %>% 
  fill(country) %>%
  pivot_longer(!c(country, source), names_to = "year", values_to = "inst_re_cap_mw") %>% 
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country), inst_re_cap_mw = as.numeric(inst_re_cap_mw), year = as.numeric(year))

################################################################################
# Renewable Electricity generation (GWh) by Region/country/area, Technology and Year
# 239 countries
re_elecgen <- read_xlsx(here("data", "raw", "Elec_gen_capacity", "RE-ELECGEN_20220908-084850.xlsx"), range = cell_rows(3:4734)) %>% 
  rename(country = `...1`, source = `...2`) %>% 
  fill(country) %>%
  filter(!(country %in% c("World","Africa","C America + Carib","Eurasia","Europe","EU 27","Middle East","N America","Oceania","S America"))) %>% 
  pivot_longer(!c(country, source), names_to = "year", values_to = "re_elecgen_gwh") %>% 
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country), year = as.numeric(year))

test_diff(re_eleccap, re_elecgen,c('country', 'source', 'year'))
re_capgen <- full_join(re_eleccap, re_elecgen, by = c('country', 'source', 'year'))

rm(re_eleccap)
rm(re_elecgen)
################################################################################
# Renewable energy share of electricity capacity and generation (%) by Region/country/area, Indicator and Year
# 234 countries
re_share_elec <- read_xlsx(here("data", "raw", "Elec_gen_capacity", "RESHARE_20220908-084915.xlsx"), range = cell_rows(3:471)) %>% 
  rename(country = `...1`, indicator = `...2`) %>% 
  fill(country) %>%
  pivot_longer(!c(country, indicator), values_transform = as.numeric, names_to = "year") %>% 
  pivot_wider(names_from = indicator, values_from = value) %>% 
  rename(re_share_eleccap_pct = `RE share of electricity capacity (%)`, re_share_elecgen_pct = `RE share of electricity generation (%)`) %>% 
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country))


# Combining re_share_elec, elec
elec_panel <- elec %>% 
  group_by(country, year) %>% 
  summarize(offgrid_cap_mw = sum(offgrid_eleccap_mw, na.rm = TRUE),
            ongrid_cap_mw = sum(ongrid_eleccap_mw, na.rm = TRUE),
            tot_cap_mw = sum(tot_eleccap_mw, na.rm = TRUE),
            ongrid_gen_gwh = sum(ongrid_elecgen_gwh, na.rm = TRUE), 
            offgrid_gen_gwh = sum(offgrid_elecgen_gwh, na.rm = TRUE), 
            tot_gen_gwh = sum(tot_elecgen_gwh, na.rm = TRUE)) %>% ungroup()
rm(elec)

re_panel <- re_capgen %>% 
  filter(source == "Total renewable energy" & country != "Asia") %>% 
  select(-source)

rm(re_capgen)
                    
re_share_panel <- re_share_elec %>% 
  filter(!(country %in% c("World", "North America", "Middle East", "South America", 
                          "Africa", "Eurasia", "Europe", "European Union", "Central America and the Caribbean", 
                          "Asia", "Oceania"))) %>% 
  mutate(year = as.numeric(year))

rm(re_share_elec)

test_diff(elec_panel, re_panel, c('country', 'year'))
test_diff(elec_panel, re_share_panel, c('country', 'year'))
test_diff(re_panel, re_share_panel, c('country', 'year'))

tot_elec_panel <- left_join(re_panel, elec_panel, by = c('country', 'year')) %>% left_join(., re_share_panel, by = c('country', 'year')) %>% tibble()
rm(re_panel)
rm(elec_panel)
rm(re_share_panel)

```

## BP Stats Review
BP Statistical Review of World Energy
https://www.bp.com/en/global/corporate/energy-economics/statistical-review-of-world-energy.html
Methodology: https://www.bp.com/content/dam/bp/business-sites/en/global/corporate/pdfs/energy-economics/statistical-review/bp-stats-review-2022-methodology.pdf

co2_combust_mtco2: Carbon Dioxide Emissions from Energy in Million tonnes of carbon dioxide
co2_combust_pc: 
co2_combust_per_ej
co2_mtco2: Carbon Dioxide Equivalent Emissions from Energy, Process Emissions, Methane, and Flaring in Million tonnes of carbon dioxide
elect_twh
electbyfuel_[]: Electricity generated from [source] (TWh)
[]_twh: Electricity generation from [source] (TWh) [PREFER THIS INDICATOR TO ELECTBYFUEL FOR: NUCLEAR, HYDRO, RENEWABLE]
[]_twh_net: Electricity generation less the electricity generation used to operate the generating station/plant.


```{r}

bp <- read_excel(here("data/raw/bp-stats-review-2022-consolidated-dataset-panel-format.xlsx")) %>%
  filter(!((Country == "Russian Federation" & Year < 1985) | (Country == "USSR" & Year >= 1985))) %>% 
  mutate(country = ifelse(Country %in% names(getcountry), unname(getcountry[Country]),
                          ifelse(Country == "USSR", "Russia", Country)),
         year = Year) %>% 
  arrange(country, year) %>% 
    select(country, year, starts_with("co2_"), starts_with("elect"), contains("twh")) %>% 
  filter(!grepl("Other", country) & !grepl("Total", country) & country != "Rest of World") 

tot_elec_panel_bp <- full_join(tot_elec_panel, bp, by = c("country", "year"))
rm(tot_elec_panel)
rm(bp)
 
```

## EDGAR V6.0

Description: The Emissions Database for Global Atmospheric Research (EDGAR) provides independent estimates of the global anthropogenic emissions and emission trends, based on publicly available statistics, for the atmospheric modeling community as well as for policy makers. This scientific independent emission inventory is characterized by a coherent world historical trend from 1970 to year x-3, including emissions of all greenhouse gases, air pollutants and aerosols.


EDGARv6.0 provides emissions of the three main greenhouse gases (CO2, CH4, N2O) and fluorinated gases per sector and country.

CO2 emissions are provided separately for CO2_excl_short-cycle_org_C and CO2_short-cycle_org_C. Emissions of CO2_excl_short-cycle_org_C include all fossil CO2 sources, such as fossil fuel combustion, non-metallic mineral processes (e.g. cement production), metal (ferrous and non-ferrous) production processes, urea production, agricultural liming and solvents use. Large scale biomass burning with Savannah burning, forest fires, and sources and sinks from land-use, land-use change and forestry (LULUCF) are excluded.
Emissions of fluorinated gases have been derived by multiple sources, most notably from country reporting where available. When not the case, activity data statistics have been derived by UNEP data, from scierntific literature and expert judgment.
https://edgar.jrc.ec.europa.eu/dataset_ghg60

edgar_elec_emissions: emissions from "Main Activity Electricity and Heat Production"
Issue: Serbia and Montenegro are combined in this dataset....
```{r}

edgar_full <- read_excel(here("data", "raw", "v60_CO2_excl_short-cycle_org_C_1970_2018.xls"), skip = 9) %>%
  pivot_longer(cols = starts_with("Y_"), names_to = "year", values_to = "emissions") %>% 
  clean_names() %>% 
  mutate(year=as.numeric(str_remove(year, "Y_")), emissions = as.numeric(emissions)) %>% 
  rename(country = name, ipcc_code = ipcc_code_2006_for_standard_report, ipcc_code_name = ipcc_code_2006_for_standard_report_name) %>% 
  select(-c_group_im24_sh) %>% 
  filter(country != "Int. Shipping" & country != "Int. Aviation") %>% 
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country))

# Create a panel with all sectors: country - year - sector
# write.xlsx(edgar_full, here("data/temp/edgar_panel_full.xlsx"))

edgar <- edgar_full %>% 
  filter(ipcc_code == "1.A.1.a") %>% 
  select(country, year, emissions) %>% 
  rename(edgar_elec_emissions = emissions)
test_diff(tot_elec_panel_bp, edgar, c("country", "year"))

rm(edgar_full)

edgar_elec_temp <- full_join(edgar, tot_elec_panel_bp, by = c("country", "year"))
rm(edgar)
rm(tot_elec_panel_bp)

```

## OWID Emissions by sector

Annual greenhouse gas emissions by sector by country 1990 - 2018

https://ourworldindata.org/emissions-by-sector#annual-greenhouse-gas-emissions-by-sector
Breakdown of total greenhouse gases (the sum of all greenhouse gases, measured in tonnes of carbon dioxide equivalents) by sector. Our data on annual emissions of total greenhouse gas emissions, methane emissions and nitrous oxide emissions is sourced from the CAIT Climate Data Explorer, and downloaded from the Climate Watch Portal. It provides estimates on total greenhouse gas emissions (including, and excluding land use change as separate metrics); methane emissions; and nitrous oxide emissions. These are measured in carbon dioxide equivalents (CO2e) based on 100-year global warming potential factors for non-CO₂ gases.

Aggregated from CAIT Climate Data Explorer via Climate Watch

The following "ghg-emissions-by-sector.csv" contains emissions by each sector (similar to in EDGAR).

owid_elec_emissions: emissions from "electricity and heat production"

```{r}

owid_full <- read.csv(here("data", "raw", "ghg-emissions-by-sector.csv")) %>%
  tibble() %>% 
  select(-2) %>% 
  setNames(tolower(gsub("[[:punct:]]and", "", 
                        gsub("energy", "", c("country", names(.)[2:13]))))) %>% 
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country)) %>% 
  filter(country != "European Union (27)" & country != "World")

# save full sectoral panel
#write.xlsx(owid_full, here("data/temp/owid_emissions_by_sector_full_panel.xlsx"))

owid_elec <- owid_full %>% 
  select(country, year, electricity.heat) %>% 
  rename(owid_elec_emissions = electricity.heat)
test_diff(edgar_elec_temp, owid_elec, c("country", "year"))

elec_temp <- left_join(edgar_elec_temp, owid_elec, by = c("country", "year"))
rm(edgar_elec_temp)
rm(owid_elec)

```

## OWID All indicators
https://github.com/owid/energy-data

Our complete Energy dataset is a collection of key metrics maintained by Our World in Data. It is updated regularly and includes data on energy consumption (primary energy, per capita, and growth rates), energy mix, electricity mix and other relevant metrics. Combined data from BP Statistical Review of World Energy, US EIA, The Shift Dataportal, Ember, 

Consumption data available for the following energy sources. 
All sources are measured in pct_change, twh_change, and total_consumption. 
Only coal, biofuel, fossil also have an indicator for consumption per capita. 
Would therefore recommend not using per capita numbers.:
- energy
- biofuel
- coal
- fossil
- gas
- gydro
- low carbon
- nuclear
- oil
- renewables
- other renewables
- solar
- wind

Energy share by source (1965-) has a longer time horizon than electricity share by source (1985 - ). 

For indicators see Variable Documentation.


```{r}

owid_all <- read_excel(here("data", "temp", "owid_all.xlsx"))

owid_elec <- owid_all %>% 
  select(country, year, population, gdp, electricity_generation, electricity_demand, 
         greenhouse_gas_emissions, per_capita_electricity, energy_cons_change_pct, 
         energy_cons_change_twh, carbon_intensity_elec, primary_energy_consumption,
         energy_per_gdp, energy_per_capita, net_elec_imports_share_demand,
         net_elec_imports, contains("low_carbon"), contains("renewable"), 
         contains("fossil")) %>% mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country)) %>% 
  mutate(country = ifelse(country == "USSR" & year < 1985, "Russia", ifelse(country == "Taiwan", "Chinese Taipei", country))) %>% 
  filter(!(country %in% c("Africa", "Antarctica", "Asia Pacific", "Eastern Africa", "Europe", "European Union (27)", "Hawaiian Trade Zone", "Middle Africa", "Middle East", "Non-OECD", "OECD", "U.S. Territories", "Western Africa", "World", "Yugoslavia", "Czechoslovakia", "U.S. Pacific Islands", "East Germany", "West Germany", "CIS", "Wake Island", "USSR")) & year >= 1965)

test_diff(owid_elec, elec_temp, c("country", "year"))
elec_temp <- left_join(elec_temp, owid_elec, by = c("country", "year"))
rm(owid_elec)

```

# IEA Emissions allocation to electricity and heat
Full title: International Energy Agency Greenhouse Gas Emissions from Energy, 1751-2020
Accessed via UK Data Service
Citation: International Energy Agency. (2021). International Energy Agency Greenhouse Gas Emissions from Energy, 1751-2020. [data collection]. 13th Edition. UK Data Service. SN: 5181, DOI: 10.5257/iea/co2/2021

Description: The Greenhouse Gas Emissions from Energy dataset (formerly the CO2 Emissions from Energy dataset) contains annual Greenhouse Gas emissions from fuel combustion and related indicators for a large selection of countries plus regional aggregates. Emissions were calculated using IEA energy databases and the default methods and emission factors given in the 2006 GLs for National Greenhouse Gas Inventories.

Sector choice: "Electricity and heat production"

elec_heat_emissions_ktco2: Expressed in thousand tonnes of CO2.
This allocation type shows emissions for the same sectors which
are present in the file CO2 Emissions From Fuel Combustion. In
particular, the emissions from electricity and heat production are
shown separately and not reallocated.

elec_heat_emissions_kgco2_pc: These ratios are expressed in kilogrammes of CO2 per capita.
This allocation type shows per capita emissions for the same
sectors which are present in the file CO2 Emissions From Fuel
Combustion. In particular, the emissions from electricity and heat
production are shown separately and not reallocated.

```{r}

iea_elec <- read_excel(here("data/raw/IEA_emissions_electricity_heat_full.xlsx"), range = cell_rows(4:5943), 
           col_names = c("country", "year", "none", "elec_heat_emissions_ktco2", "elec_heat_emissions_kgco2_pc")) %>%
  select(-none) %>%
  fill(country) %>% 
  filter(!country %in% c("World","World aviation bunkers","World marine bunkers",
                         "Africa","Other Africa","Middle East","OECD Americas",
                         "Non-OECD Americas","Other non-OECD Americas","OECD Asia Oceania",
                         "Non-OECD Asia (excluding China)","Other non-OECD Asia","OECD Europe",
                         "Non-OECD Europe and Eurasia", "Former Soviet Union (if no detail)", 
                         "Former Yugoslavia (if no detail)","Memo: IEA Total",
                         "Memo: IEA and Accession/Association countries","Memo: OECD Total",
                         "Memo: Non-OECD Total","Memo: Africa (UN)","Memo: Americas (UN)",
                         "Memo: Asia (UN)","Memo: Europe (UN)","Memo: Oceania (UN)",
                         "Memo: ASEAN","Memo: European Union-27","Memo: European Union-28",
                         "Memo: FSU 15","Memo: G20","Memo: G7","Memo: G8","Memo: OPEC",
                         "Memo: Annex B Kyoto Parties","Memo: Annex I EIT","Memo: Annex I Parties",
                         "Memo: non-Annex I Parties", "Memo: Annex II Asia Oceania",
                         "Memo: Annex II Europe","Memo: Annex II North America","Memo: Annex II Parties",
                         "China (P.R. of China and Hong Kong, China)", 
                         "Memo: Former Yugoslavia")) %>% 
  mutate(across('country', str_replace, 'Memo: ', '')) %>% 
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country),
         year = as.numeric(year),
         elec_heat_emissions_ktco2 = as.numeric(elec_heat_emissions_ktco2),
         elec_heat_emissions_kgco2_pc = as.numeric(elec_heat_emissions_kgco2_pc))

test_diff(iea_elec, elec_temp, c("country", "year"))

elec_temp <- left_join(elec_temp, iea_elec, by = c("country", "year"))
rm(iea_elec)

```

# Population and GDP controls
Sourced from the World Bank.

Population: https://data.worldbank.org/indicator/SP.POP.TOTL
GDP (current US$): https://data.worldbank.org/indicator/NY.GDP.MKTP.CD
GDP per capita (current US$): https://data.worldbank.org/indicator/NY.GDP.PCAP.CD


```{r}

pop_stats <- read.csv(here("data/raw/WB_pop_stats.csv"), nrows = 9114) %>% select(1,3,5) %>% 
  rename(year = Time, country = Country.Name, population_wb = `Population..total..SP.POP.TOTL.`) %>% 
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country))

gdp_stats <- read.csv(here("data/raw/WB_GDP.csv"), nrows = 9114) %>% 
  select(1,3,5,6) %>% 
  rename(year = Time, country = Country.Name, wb_gdp = 3, wb_gdppc = 4) %>% 
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country), year = as.numeric(year), wb_gdp  = as.numeric(wb_gdp), wb_gdppc = as.numeric(wb_gdppc)) 

full <- left_join(pop_stats, gdp_stats, by = c("country", "year")) %>% 
  filter(!(country %in% c("Channel Islands", "Isle of Man"))) %>% 
  left_join(elec_temp, ., by = c("country", "year"))

rm(pop_stats)
rm(gdp_stats)
rm(owid_all)
rm(owid_full)
rm(elec_temp)

```

# OECD Emissions by Sector

This dataset presents trends in man-made emissions of major greenhouse gases and emissions by gas.

Data refer to total emissions of CO2 (emissions from energy use and industrial processes, e.g. cement production), CH4 (methane emissions from solid waste, livestock, mining of hard coal and lignite, rice paddies, agriculture and leaks from natural gas pipelines), nitrous oxide (N2O), hydrofluorocarbons (HFCs), perfluorocarbons (PFCs), sulphur hexafluoride (SF6) and nitrogen trifluoride (NF3). Data exclude indirect CO2.

Concerning Global Warming Potentials (GWP) when converting the data from tonnes to CO2 equivalents for Annex I countries these calculations were based on defaults from Assessment Report 4 (AR4). As regards the non-Annex I countries the factors from the following reports were used: Costa Rica, Israel, Korea, Peru - Second Assessment Report, Chile - AR4 and for Colombia, Mexico - AR5.

Data source(s) used:
National Inventory Submissions 2022  to the United Nations Framework Convention on Climate Change (UNFCCC, CRF tables), and replies to the OECD State of the Environment Questionnaire.

Indicators (all measured in Tonnes of CO2 equivalent, Thousands):
tot_emissions_excl_lulucf: Total emissions excluding LULUCF
tot_emissions_incl_lulucf: Total emissions including LULUCF
emissions_energy_total (1): Emissions from "Energy" (SUM: Energy industries, Manufacturing Industries and Construction, Transport, Residential and Other Sectors, Energy Other, Fugtiive Emissions from Fuels, CO2 from transport and storage)
emissions_elec (1A1): Emissions from Energy Industries
emissions_residential (1A4): Emissions from Energy in Residential and Other Sectors
emissions_energy_other (1A5): Emissions from "Other" Energy

```{r}
oecd_elec <- read_xlsx(here("data/raw/OECD_GHG_total_emissions_by sector.xlsx"), range = cell_rows(3:1629)) %>% 
    clean_names() %>% 
    fill(country) %>% 
  select(country, year, total_emissions_excluding_lulucf, total_emissions_including_lulucf, x1_energy, x1a1_energy_industries, x1a4_residential_and_other_sectors, x1a5_energy_other) %>% 
  rename(tot_emissions_excl_lulucf = total_emissions_excluding_lulucf, 
         tot_emissions_incl_lulucf =  total_emissions_including_lulucf,
         emissions_energy_total = x1_energy,
         emissions_elec = x1a1_energy_industries,
         emissions_residential = x1a4_residential_and_other_sectors,
         emissions_energy_other = x1a5_energy_other) %>% 
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country), year = as.numeric(year)) %>% 
  filter(country != "OECD Asia Oceania")

test_diff(oecd_elec, full, c("country", "year"))

OECD_vec <- OECD
data_oecd <- left_join(full, oecd_elec, by = c("country", "year")) %>% 
  select(-c(population, gdp)) %>% 
  mutate(EU = ifelse(country %in% EU31,1,0),
         OECD = ifelse(country %in% OECD_vec,1,0)) 

rm(oecd_elec)
rm(OECD_vec)
rm(full)

```

#EDGAR v7.0
Released 2022

Description: Timeseries of fossil CO2 from 1970 till 2021 for all world countries with sector-specific break-down. CO2 LULUCF emissions from 1990 to 2021 by macro-regions. The Emissions Database for Global Atmospheric Research (EDGAR) provides independent estimates of the global anthropogenic emissions and emission trends, based on publicly available statistics, for the atmospheric modeling community as well as for policy makers. This scientific independent emission inventory is characterized by a coherent world historical trend from 1970 to year x-3, including emissions of all greenhouse gases, air pollutants and aerosols.

https://data.jrc.ec.europa.eu/dataset/e0344cc3-e553-4dd4-ac4c-f569c8859e19

Indicators:
edgar_power_emissions: emissions from power industry
Verified: Largely identical to V6.0 EDGAR indicator chosen above apart from a few (likely) improvements in data coverage.

```{r}
edgar_v7 <- read_xlsx(here("data/raw/EDGARv7.0_FT2021_fossil_CO2_booklet2022.xlsx"), sheet = "fossil_CO2_by_sector_and_countr") %>% 
  rename(country = Country) %>% 
  filter(Sector == "Power Industry") %>% 
  select(-c("Substance", "EDGAR Country Code", "Sector")) %>% 
  pivot_longer(!c(country), names_to = 'year', values_to = 'edgar_power_emissions', values_transform = c(edgar_power_emissions = as.numeric)) %>%
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country), year = as.numeric(year))
                       
test_diff(edgar_v7, data_oecd, c("country", "year"))

datav7 <- left_join(data_oecd, edgar_v7, by = c("country", "year")) %>% 
  rename(gdp = wb_gdp, 
                  gdp_pc = wb_gdppc, 
                  pop = population_wb, 
                  bp_energy_mtco2 = co2_combust_mtco2,
                  edgar_v6_elec_ktco2 = edgar_elec_emissions,
                  owid_1_elec_heat_tco2e = owid_elec_emissions, 
                  owid_2_elec_mtco2e = greenhouse_gas_emissions,
                  edgar_v7_elec_mtco2 = edgar_power_emissions, 
                  iea_elec_heat_ktco2 = elec_heat_emissions_ktco2,
                  oecd_ktco2e = emissions_elec) %>% 
    mutate(pop = as.numeric(pop),
           emissions_residential = as.numeric(emissions_residential),
           emissions_energy_other =  as.numeric(emissions_energy_other)) %>% 
  relocate(country, year, gdp, gdp_pc, pop, EU, OECD,
                  edgar_v6_elec_ktco2,
                  edgar_v7_elec_mtco2, 
                  owid_1_elec_heat_tco2e, 
                  owid_2_elec_mtco2e,
                  bp_energy_mtco2,
                  iea_elec_heat_ktco2,
                  oecd_ktco2e)



#saveRDS(data, here("data/out/elec_emissions_panel_clean_22.RDS"))

# rm(data_oecd)
# rm(datav7)
# rm(edgar_v7)

```

# Weather indicators

```{r}
#data <- readRDS(here("data/out/elec_emissions_panel_clean_22.RDS"))

hdd <- read.csv(here("data/raw/IEA-CMCC-WeatherForEnergy-HDD16dailybypop-from-2000-to-2022.csv")) %>% 
  select(Territory, Date, HDD16dailybypop) %>% 
  rename(country = Territory, year = Date)

cdd <- read.csv(here("data/raw/IEA-CMCC-WeatherForEnergy-CDD18dailybypop-from-2000-to-2022.csv")) %>% 
  select(Territory, Date, CDD18dailybypop) %>% 
  rename(country = Territory, year = Date)

test_diff(hdd, cdd, c("country", "year"))

temp_dat <- left_join(hdd, cdd, by = c("country", "year")) %>% 
   mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country))
  
test_diff(temp_dat, datav7, c("country", "year"))
rm(hdd, cdd)
data <- left_join(datav7, temp_dat, by = c('country', 'year'))

cdd <- read.xlsx(here("data/raw/nrg_chdd_a_spreadsheet.xlsx"), sheet = "CDD", rows = 9:39) %>% 
  pivot_longer(!TIME, names_to = 'year', values_to = 'CDD') %>% 
  rename(country = TIME) %>% 
  mutate(country = ifelse(country == "Germany (until 1990 former territory of the FRG)", "Germany", ifelse(country %in% names(getcountry), unname(getcountry[country]), country)), year = as.numeric(year))

hdd <- read.xlsx(here("data/raw/nrg_chdd_a_spreadsheet.xlsx"), sheet = "HDD", rows = 9:39) %>%
  pivot_longer(!TIME, names_to = 'year', values_to = 'HDD') %>% 
  rename(country = TIME) %>% 
    mutate(country = ifelse(country == "Germany (until 1990 former territory of the FRG)", "Germany", ifelse(country %in% names(getcountry), unname(getcountry[country]), country)), year = as.numeric(year))

data <- full_join(cdd, hdd, by = c("country", "year")) %>% 
  left_join(data, ., by = c("country", "year"))

readRDS(here("data/out/elec_emissions_panel_clean_22.RDS")) %>% select(1:104) %>% 
all.equal(data)

```

# GDP (constant 2015)

```{r}

gdp_c <- read.csv(here('data/raw/wb_constant2015_GDP.csv'), nrows = 10199) %>%
  rename(year = Time, country = Country.Name, gdp_const = "GDP..constant.2015.US....NY.GDP.MKTP.KD.") %>% 
  select(year, country, gdp_const) %>% 
   mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country),
          gdp_const = as.numeric(gdp_const))

w_gdp <- left_join(data, gdp_c, by = c('country', 'year')) 

#saveRDS(w_gdp, here("data/out/elec_emissions_panel_clean_22.RDS"))
# Canada missing from 1990-1996: Comparing and supplementing with OECD data

```

# OECD GDP in constant 2015 prices & Canadian Supplement (missing from WB)
Gross domestic product (GDP): GDP in millions US dollars, Constant prices, constant exchange rates, OECD base year"

Canadian supplement 1990-1996 missing from WB, supplementing with data from OECD: Canadian values from OECD database merged into WB column

```{r}

# RETAINED B/C OVERLAPS WITH WB INDICATOR: 
# --- "Constant prices, constant exchange rates, OECD base year" (2015 base year)
# Current prices: reference period == NA
# Constant prices, national base year: reference period == 2012
# All others ("Current prices, constant exchange rates, OECD base year";
#             "Constant prices, constant exchange rates, OECD base year";
#             "Constant prices, constant PPPs, OECD base year";
#             "Constant prices, OECD base year"): reference period == 2015

oecd_gdp <- read.csv(here('data/raw/OECD_GDP_constant_current prices_allcountries.csv')) %>% tibble() %>% 
  filter(Unit.Code == "USD" & 
           Measure == "Constant prices, constant exchange rates, OECD base year" & 
           Transaction == "Gross domestic product (expenditure approach)") %>% 
  select(Country, Year, Value) %>% 
  rename(country = Country, year = Year, gdp_const_oecd = Value) %>%
  mutate(country = ifelse(country %in% names(getcountry), unname(getcountry[country]), country),
          gdp_const_oecd = gdp_const_oecd*1000000)

full_gdp <- left_join(w_gdp, oecd_gdp, by = c('country', 'year'))
  
# Replace Canada values in WB GDP with OECD GDP values
full_gdp$gdp_const[full_gdp$country == "Canada"] <- full_gdp$gdp_const_oecd[full_gdp$country == "Canada"]

full_gdp %>% 
  filter(country %in% sel) %>%
  ggplot() +
  geom_line(aes(x = year, y = gdp_const), color = "red") +
  geom_line(aes(x = year, y = gdp_const_oecd), color = "black", linetype = "dashed") +
  facet_wrap(vars(country), scales = "free")

readRDS(here("data/out/elec_emissions_panel_clean_22.RDS")) %>% 
  identical(full_gdp)

#saveRDS(full_gdp, here("data/out/elec_emissions_panel_clean_22.RDS"))

```

# HDD & CDD Manual Calculation: All countries except USA, Canada, (correct) Australia
```{r}

# All countries in selected sample except USA, Canada, (correct) Australia
country_files <- list.files(here("data/raw/HDD_CDD/HDD_CDD_renewables_ninja"))
dd_comp <- tibble(year = numeric(), cat = character(), n = numeric(), country = character())
for(cy in sel){
  file <- country_files[grepl(cy, country_files)]
  if(length(file) == 0){
    print(paste(cy, "still needed!"))
  }else{
    dd_comp <- read.csv(here(paste0("data/raw/HDD_CDD/HDD_CDD_renewables_ninja/", file)), skip = 2) %>% 
      tibble %>% 
      select(time, temperature) %>% 
      mutate(date_full = ymd_hms(time), 
             time_stamp = format(as.POSIXct(date_full), format = "%H:%M:%S"), 
             date = as.Date(date_full),
             year = lubridate::year(date_full)) %>%
      group_by(date, year) %>% 
      summarise(avg_temp = sum(temperature)/24, 
                cdd_d = ifelse(avg_temp > 18, avg_temp - 18, 0),
                hdd_d = ifelse(avg_temp < 16, 16 - avg_temp, 0)) %>% 
      group_by(year) %>% 
      summarise(cdd = sum(cdd_d),
                hdd = sum(hdd_d)) %>% ungroup %>% 
      pivot_longer(!year, names_to = "cat", values_to = "n") %>% mutate(country = cy) %>% rbind(dd_comp)
  }
}

```

# Manual CDD & HDD Calculation: USA
Population estimate citations: US Census Bureau

1990-2000: Table CO-EST2001-12-00 - Time Series of Intercensal State Population Estimates: April 1, 1990 to April 1, 2000; Population Division, U.S. Census Bureau
```{r}

us_dd <- tibble(year = numeric(), cat = character(), n = numeric(), state = character())

for(s in state.abb){
  us_dd <- read.csv(paste0("https://www.renewables.ninja/country_downloads/US/ninja_weather_country_US.",s,"_merra-2_population_weighted.csv"), skip = 2) %>% 
    tibble %>% 
    select(time, temperature) %>% 
    mutate(date_full = ymd_hms(time), 
           time_stamp = format(as.POSIXct(date_full), format = "%H:%M:%S"), 
           date = as.Date(date_full),
           year = lubridate::year(date_full)) %>% 
    group_by(date, year) %>% 
    summarise(avg_temp = sum(temperature)/24, 
              cdd_d = ifelse(avg_temp > 18, avg_temp - 18, 0),
              hdd_d = ifelse(avg_temp < 16, 16 - avg_temp, 0)) %>% 
    group_by(year) %>% 
    summarise(cdd = sum(cdd_d),
              hdd = sum(hdd_d)) %>% ungroup %>% 
    pivot_longer(!year, names_to = "cat", values_to = "n") %>% mutate(state = s) %>% 
    rbind(us_dd,.)
}

# Population estimates 1990-2021
# 2020-2021
us_21_20 <- read.xlsx(here("data/raw/US_state_pop_est/NST-EST2021-POP.xlsx"), rows = 4:62) %>% 
  tibble %>%
  mutate(state_name = gsub("\\.", "", X1), state = state.abb[match(state_name,state.name)]) %>% 
  select(state, `2020`, `2021`) %>% 
  filter(!is.na(state)) %>% pivot_longer(!state, names_to = 'year', values_to = 'pop') %>% mutate(year = as.numeric(year))

us_19_10 <- read.xlsx(here("data/raw/US_state_pop_est/nst-est2019-01.xlsx"), rows = 4:62) %>% tibble %>% 
  mutate(state_name = gsub("\\.", "", X1), state = state.abb[match(state_name,state.name)]) %>% 
  select(-c(X1, Census, Estimates.Base, state_name)) %>% 
  relocate(state) %>% 
  filter(!is.na(state)) %>% pivot_longer(!state, names_to = 'year', values_to = 'pop') %>% mutate(year = as.numeric(year))

us_09_00 <- read_excel(here("data/raw/US_state_pop_est/st-est00int-01.xls"), skip = 3, n_max = 58) %>% 
  tibble %>% 
  mutate(state_name = gsub("\\.", "", `...1`), state = state.abb[match(state_name,state.name)]) %>% 
  select(-c(`...1`, `...2`, state_name, `...13`, `...14`)) %>% 
  relocate(state) %>% 
  filter(!is.na(state)) %>% 
  pivot_longer(!state, names_to = 'year', values_to = 'pop') %>% 
  mutate(year = as.numeric(year))

us_99_90 <- pdf_text("https://www2.census.gov/programs-surveys/popest/tables/1990-2000/intercensal/st-co/co-est2001-12-00.pdf") %>% 
  paste() %>% str_split("\n") %>% 
  unlist %>% tibble %>% slice(6:65) %>%
  separate(data = ., col = `.`,  sep = "\\s(?=\\d)",  
           into = c("state", "1990est", 1990, 1991, 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000)) %>% 
  mutate(across(everything(), trimws)) %>% 
  mutate(state = state.abb[match(state,state.name)], across(2:13, ~as.numeric(gsub(",", "", .x)))) %>% 
  filter(!is.na(state)) %>% select(-c(`1990est`, `2000`)) %>% 
  pivot_longer(!state, names_to = 'year', values_to = 'pop') %>% 
  mutate(year = as.numeric(year))

pop <- rbind(us_21_20, us_19_10, us_09_00, us_99_90) %>% group_by(year) %>% 
  mutate(tot_pop = sum(pop), prop_pop = pop/tot_pop)

us_dd_tot <- us_dd %>% left_join(pop, by = c('state', 'year')) %>% filter(year >= 1990) %>% group_by(year) %>% mutate(dd_prop = n*prop_pop) %>% group_by(year, cat) %>% summarise(dd_tot = sum(dd_prop)) %>% mutate(country = "United States")

# Calculate mean differences: -0.0490 & 0.0776
readRDS(here("data/out/elec_emissions_panel_clean_22.RDS")) %>% 
  filter(country == "United States" & year >= 2000) %>% select(country, year, HDD16dailybypop, CDD18dailybypop) %>% rename(hdd = HDD16dailybypop, cdd = CDD18dailybypop) %>%  
  pivot_longer(cols = c(hdd, cdd), names_to = "cat", values_to = "n") %>% left_join(filter(us_dd_tot, year >= 2000), by = c("year", "cat")) %>% mutate(frac = n/dd_tot) %>% group_by(cat) %>% summarise(1 - mean(frac, na.rm = TRUE))

```

# Manual CDD & HDD Calculation: Australia
Population Statistics Citation: 
Australian Bureau of Statistics 2022, National, state and territory population, ABS, viewed 7 November 2022, <https://www.abs.gov.au/statistics/people/population/national-state-and-territory-population/mar-2022>.
```{r}

aus.abbr <- c(australian_capital_territory = "CT", 
              new_south_wales = "NS", 
              northern_territory = "NT", 
              queensland = "QL", 
              south_australia = "SA", 
              tasmania = "TS", 
              victoria = "VI", 
              western_australia = "WA")

aus_dd <- tibble(year = numeric(), cat = character(), n = numeric(), state = character())

for(a in aus.abbr){
  aus_dd <- read.csv(paste0("https://www.renewables.ninja/country_downloads/AU/ninja_weather_country_AU.",a,"_merra-2_population_weighted.csv"), skip = 2) %>% 
 tibble %>% 
  select(time, temperature) %>% 
  mutate(date_full = ymd_hms(time),
         time_stamp = format(as.POSIXct(date_full), format = "%H:%M:%S"),
         date = as.Date(date_full),
         year = lubridate::year(date_full)) %>%
  group_by(date, year) %>%
  summarise(avg_temp = sum(temperature)/24,
            cdd_d = ifelse(avg_temp > 18, avg_temp - 18, 0),
            hdd_d = ifelse(avg_temp < 16, 16 - avg_temp, 0)) %>%
  group_by(year) %>%
  summarise(cdd = sum(cdd_d),
            hdd = sum(hdd_d)) %>% ungroup %>%
  pivot_longer(!year, names_to = "cat", values_to = "n") %>% 
    mutate(state = a) %>% 
    rbind(aus_dd,.)
}

aus_pop <- read_excel(here("data/raw/HDD_CDD/HDD_CDD_US_AUS_CAN/AUS_pop_310104.xlsx"), 
                      sheet = "Data1", col_types = c("date", rep("numeric", 27))) %>% 
  slice(-c(1:9)) %>% clean_names %>% select(x1, contains("persons")) %>%
  rename_with(cols = everything(), ~gsub("estimated_resident_population_persons_", "", .)) %>% 
  rename(date_full = x1) %>% 
  mutate(year = lubridate::year(date_full)) %>% 
  group_by(year) %>%
  summarise(across(everything(), mean)) %>% select(-date_full) %>% 
    pivot_longer(!year, names_to = "state", values_to = "pop") %>% 
  mutate(state = unname(aus.abbr[state])) %>% filter(!is.na(state)) %>% 
  group_by(year) %>% 
    mutate(tot_pop = sum(pop), prop_pop = pop/tot_pop)

aus_dd_tot <- aus_dd %>% left_join(aus_pop, by = c('state', 'year')) %>% filter(year >= 1990) %>% group_by(year) %>% mutate(dd_prop = n*prop_pop) %>% group_by(year, cat) %>% summarise(dd_tot = sum(dd_prop)) %>% mutate(country = "Australia")

# Mean differences: 0.0518 & -0.109
data %>% 
  filter(country == "Australia" & year >= 2000) %>% select(country, year, HDD16dailybypop, CDD18dailybypop) %>% rename(hdd = HDD16dailybypop, cdd = CDD18dailybypop) %>%  
  pivot_longer(cols = c(hdd, cdd), names_to = "cat", values_to = "n") %>% left_join(filter(aus_dd_tot, year >= 2000), by = c("year", "cat")) %>% mutate(frac = n/dd_tot) %>% group_by(cat) %>% summarise(1- mean(frac, na.rm = TRUE))

```

# Manual CDD & HDD Calculation: Canada
Population stats: https://www150.statcan.gc.ca/t1/tbl1/en/cv.action?pid=1710000501
Cite: Statistics Canada
```{r}

can.abbr <- read.xlsx(here('data/raw/HDD_CDD/HDD_CDD_US_AUS_CAN/can_abbrev.xlsx'), rowNames = TRUE)

can_dd <- tibble(year = numeric(), cat = character(), n = numeric(), state = character())

for(p in can.abbr$abbr){
    can_dd <- read.csv(paste0("https://www.renewables.ninja/country_downloads/CA/ninja_weather_country_CA.",p,"_merra-2_population_weighted.csv"), skip = 2) %>% 
     tibble %>% 
      select(time, temperature) %>% 
      mutate(date_full = ymd_hms(time),
             time_stamp = format(as.POSIXct(date_full), format = "%H:%M:%S"),
             date = as.Date(date_full),
             year = lubridate::year(date_full)) %>%
      group_by(date, year) %>%
      summarise(avg_temp = sum(temperature)/24,
                cdd_d = ifelse(avg_temp > 18, avg_temp - 18, 0),
                hdd_d = ifelse(avg_temp < 16, 16 - avg_temp, 0)) %>%
      group_by(year) %>%
      summarise(cdd = sum(cdd_d),
                hdd = sum(hdd_d)) %>% ungroup %>%
      pivot_longer(!year, names_to = "cat", values_to = "n") %>% 
         mutate(state = p) %>% 
          rbind(can_dd,.)
}

can_pop <- read.csv(here('data/raw/HDD_CDD/HDD_CDD_US_AUS_CAN/Canada_province_pops.csv')) %>% tibble %>% 
    filter(Age.group == "All ages", 
           GEO %in% c(rownames(can.abbr))) %>%
    select(REF_DATE, GEO, VALUE) %>%
    rename(year = REF_DATE, state = GEO, pop = VALUE) %>% 
    group_by(year) %>% 
    mutate(prop_pop = pop/sum(pop), tot_pop = sum(pop), state = can.abbr[state,])

can_dd_tot <- can_dd %>% left_join(can_pop, by = c('state', 'year')) %>% group_by(year) %>% mutate(dd_prop = n*prop_pop) %>% group_by(year, cat) %>% summarise(dd_tot = sum(dd_prop, na.rm = TRUE)) %>% mutate(country = "Canada")

# Mean differences: -.0681 & 0.0431
data %>% 
  filter(country == "Canada" & year >= 2000) %>% select(country, year, HDD16dailybypop, CDD18dailybypop) %>% rename(hdd = HDD16dailybypop, cdd = CDD18dailybypop) %>%  
  pivot_longer(cols = c(hdd, cdd), names_to = "cat", values_to = "n") %>% left_join(filter(can_dd_tot, year >= 2000), by = c("year", "cat")) %>% mutate(frac = n/dd_tot) %>% group_by(cat) %>% summarise(1-mean(frac, na.rm = TRUE))

```

# Combine Manual Calculation HDD & CDD
```{r}

# Add Canada and USA
dd_comp_aus_us_can <- us_dd_tot %>% rbind(., can_dd_tot) %>% rename(n = dd_tot) %>% rbind(dd_comp, .)

# Replace values for Australia 1990-2019
dd_comp_aus_us_can$n[which(dd_comp_aus_us_can$country == "Australia" & dd_comp_aus_us_can$year %in% 1990:2019)] <- aus_dd_tot$dd_tot

# Incorporating values for 2020-2021
dd_20_21 <- if(readRDS(here("data/out/elec_emissions_panel_clean_22.RDS")) %>% identical(full_gdp)){
  readRDS(here("data/out/elec_emissions_panel_clean_22.RDS")) %>% filter(country %in% sel & year >= 2020) %>% select(year, country, HDD16dailybypop, CDD18dailybypop) %>% rename(hdd = HDD16dailybypop, cdd = CDD18dailybypop) %>% pivot_longer(cols = !c(country, year), names_to = 'cat', values_to = 'n')
}else{break}

# Merge with main dataset
data_dd_full <- rbind(dd_20_21, dd_comp_aus_us_can) %>% pivot_wider(id_cols = c(year, country), names_from = cat, values_from = n) %>%  left_join(full_gdp, ., by = c('year', 'country'))

# Sanity check
data_dd_full %>% select(1:106) %>% identical(full_gdp)

data_dd_full %>% filter(country %in% sel & year >= 1990) %>% 
  select(year, country, hdd, cdd, HDD16dailybypop, CDD18dailybypop) %>% 
  pivot_longer(cols = !c(year, country), names_to = 'cat', values_to = 'n') %>% 
  ggplot() +
  geom_line(aes(x = year, y = n, color = cat)) + 
  facet_wrap(vars(country), scales = "free")

saveRDS(data_dd_full,here("data/out/elec_emissions_panel_clean_22.RDS"))

```

# Variable Documentation
```{r, eval = FALSE, include = FALSE}

vars <- read_xlsx(here("data/out/Variable_Documentation.xlsx"))

#write.xlsx(vars, here("data/out/Variable_Documentation.xlsx"))
all.equal(vars$Name, names(data))
# vars[match(names(data), vars$Name),]  %>% identical(vars)

```

